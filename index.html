<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cox Punch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-grad: linear-gradient(90deg, #ff3b2e, #ff9500);
    --primary-color: #ff3b2e;
    --dark-bg: #222;
    --light-bg: #f8f8f8;
    --table-header-bg: #ff5e3a;
  }
  body {
    font-family: 'Montserrat', sans-serif;
    margin: 0;
    background-color: var(--light-bg);
    color: #000;
    display: flex;
    flex-direction: row;
    gap: 2rem;
    padding: 1rem;
  }
  header {
    text-align: center;
    padding: 1rem;
  }
  header h1 {
    font-size: 2rem;
    font-weight: 700;
    background: var(--primary-grad);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }
  header p {
    font-size: 1rem;
    color: #555;
    margin: 0.3rem 0 0;
  }
  .main {
    flex: 2;
  }
  .sidebar {
    flex: 1;
    background: #fff;
    border: 1px solid #ccc;
    padding: 1rem;
    font-size: 0.9rem;
  }
  input, select, button {
    width: 100%;
    padding: 0.6rem;
    font-size: 1rem;
    margin: 0.3rem 0 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  button {
    background: var(--primary-grad);
    border: none;
    color: #fff;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover {
    opacity: 0.9;
  }
  .result {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #fff;
    border: 1px solid #ccc;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }
  th, td {
    padding: 0.4rem;
    text-align: center;
    border: 1px solid #ccc;
  }
  th {
    background: var(--table-header-bg);
    color: #fff;
  }
  tr:nth-child(even) {
    background-color: #f1f1f1;
  }
  .collapse-btn {
    display: none;
    background: var(--primary-grad);
    color: #fff;
    border: none;
    padding: 0.5rem;
    margin: 0.5rem 0;
    cursor: pointer;
    width: 100%;
    text-align: left;
    font-weight: bold;
  }
  @media (max-width: 768px) {
    body {
      flex-direction: column;
    }
    .sidebar {
      display: none;
    }
    .collapse-btn {
      display: block;
    }
  }
  .adjusted-pace {
    font-weight: bold;
  }
  .heat-moderate {
    color: orange;
  }
  .heat-high {
    color: red;
  }
</style>
</head>
<body>

<div class="main">
  <header>
    <h1>COX PUNCH</h1>
    <p>Your Daily Speed Workout</p>
  </header>

  <label for="timeInput">Enter your recent 5K time (mm:ss):</label>
  <input type="text" id="timeInput" placeholder="e.g. 20:30">

  <details>
    <summary><strong>Weather Adjustment (optional)</strong></summary>
    <label for="zipInput">Enter ZIP Code:</label>
    <input type="text" id="zipInput" placeholder="e.g. 10001">
    <button id="weatherBtn">Fetch Weather</button>
    <div id="weatherInfo"></div>
  </details>

  <button id="generateBtn">Generate Workout</button>

  <div class="result" id="result" style="display:none;"></div>
</div>

<button class="collapse-btn" onclick="toggleSidebar()">Show/Hide Pace Chart</button>
<div class="sidebar" id="sidebar">
  <h3>Your VDOT Punch Paces</h3>
  <div id="paceChart">Enter a time to see pace chart</div>
</div>

<script>
  const distances = ["100", "200", "400", "600", "800", "1000", "1200", "mile", "strides"];
  const paces = ["800m pace", "mile pace", "3k pace", "5k Punch Pace", "10k Punch Pace", "HMP", "MP"];
  const minPaceForDistance = { "100": null, "200": "800m pace", "400": "mile pace", "600": "mile pace", "800": "3k pace", "1000": "5k Punch Pace", "1200": "HMP", "mile": "MP" };
  const paceMapping = { "800m pace": 0, "mile pace": 1, "3k pace": 2, "5k Punch Pace": 3, "10k Punch Pace": 4, "HMP": 5, "MP": 6 };
  const metersLookup = { "100": 100, "200": 200, "400": 400, "600": 600, "800": 800, "1000": 1000, "1200": 1200, "mile": 1609 };
  const paceChart = { /* ... pace chart data from your original code ... */ };

  let weatherData = null;

  function estimateVDOT(minutes, seconds) {
    const timeSec = minutes * 60 + seconds;
    const vdotTable = [
      { time: "15:45", vdot: 65 }, { time: "16:00", vdot: 64 }, { time: "16:15", vdot: 63 },
      { time: "16:30", vdot: 62 }, { time: "16:45", vdot: 61 }, { time: "17:00", vdot: 60 },
      { time: "17:15", vdot: 59 }, { time: "17:30", vdot: 58 }, { time: "17:45", vdot: 57 },
      { time: "18:00", vdot: 56 }, { time: "18:15", vdot: 55 }, { time: "18:30", vdot: 54 },
      { time: "18:45", vdot: 53 }, { time: "19:00", vdot: 52 }, { time: "19:15", vdot: 51 },
      { time: "19:30", vdot: 50 }, { time: "19:45", vdot: 49 }, { time: "20:00", vdot: 48 },
      { time: "20:15", vdot: 47 }, { time: "20:30", vdot: 46 }, { time: "20:45", vdot: 45 }
    ];
    for (let row of vdotTable) {
      const [min, sec] = row.time.split(":").map(Number);
      if (timeSec <= min * 60 + sec) return row.vdot;
    }
    return 45;
  }

  function showPaceChart(vdot) {
    let html = "<table><tr><th>Punch Pace</th><th>min/mi</th></tr>";
    for (let pace in paceChart) {
      html += `<tr><td>${pace}</td><td>${paceChart[pace][vdot] || "--"}</td></tr>`;
    }
    html += "</table>";
    document.getElementById("paceChart").innerHTML = html;
  }

  function chooseRepCount(metersPerRep) {
    const reps = [1, 2, 3, 4];
    const weights = [0.5, 0.25, 0.15, 0.10];
    let filtered = reps.filter((r, i) => r * metersPerRep <= 1609);
    let totalWeight = filtered.reduce((sum, r, i) => sum + weights[i], 0);
    let rnd = Math.random() * totalWeight;
    for (let i = 0; i < filtered.length; i++) {
      if (rnd < weights[i]) return filtered[i];
      rnd -= weights[i];
    }
    return 1;
  }

  function generateWorkout() {
    const input = document.getElementById("timeInput").value.trim();
    const match = input.match(/^(\d+):(\d{1,2})$/);
    if (!match) return alert("Enter time in mm:ss format");

    const minutes = parseInt(match[1]);
    const seconds = parseInt(match[2]);
    const vdot = estimateVDOT(minutes, seconds);
    showPaceChart(vdot);

    const dist = distances[Math.floor(Math.random() * distances.length)];
    let output = `<h2>Today's Workout</h2>`;

    if (dist === "100") {
      output += `<p><strong>Distance:</strong> 100m × 4</p><p><strong>Pace:</strong> All out</p>`;
    } else if (dist === "strides") {
      output += `<p><strong>Workout:</strong> 6 strides at max effort</p>`;
    } else {
      const minPace = minPaceForDistance[dist];
      const minIndex = paceMapping[minPace];
      const validPaces = paces.filter(p => paceMapping[p] >= minIndex);
      const paceType = validPaces[Math.floor(Math.random() * validPaces.length)];
      const meters = metersLookup[dist];
      const reps = chooseRepCount(meters);
      const paceStr = paceChart[paceType]?.[vdot];

      output += `<p><strong>Distance:</strong> ${dist} × ${reps}</p>`;
      output += `<p><strong>Pace:</strong> ${paceType}</p>`;
      output += `<p><strong>Target Pace:</strong> ${paceStr || "--"} per mile</p>`;

      if (weatherData) {
        const adj = adjustForHeat(paceStr, weatherData.heatIndex);
        const heatClass = adj.percent >= 0.1 ? "heat-high" : "heat-moderate";
        output += `<p class="adjusted-pace ${heatClass}">Adjusted for Heat Index ${weatherData.heatIndex}°F: ${adj.adjustedPace} per mile</p>`;
      }
    }

    output += `<p><em>VDOT ~${vdot} based on your 5K time of ${minutes}:${seconds.toString().padStart(2, '0')}</em></p>`;
    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = output;
  }

  function adjustForHeat(paceStr, heatIndex) {
    const slowdownTable = [
      { hi: 70, percent: 0.01 }, { hi: 75, percent: 0.03 },
      { hi: 80, percent: 0.05 }, { hi: 85, percent: 0.07 },
      { hi: 90, percent: 0.10 }, { hi: 95, percent: 0.13 }
    ];
    let percent = 0;
    for (let row of slowdownTable) {
      if (heatIndex >= row.hi) percent = row.percent;
    }
    const [min, sec] = paceStr.split(":").map(Number);
    const totalSec = min * 60 + sec;
    const adjSec = Math.round(totalSec * (1 + percent));
    const adjPace = `${Math.floor(adjSec/60)}:${(adjSec%60).toString().padStart(2,"0")}`;
    return { adjustedPace: adjPace, percent };
  }

  async function fetchWeather() {
    const zip = document.getElementById("zipInput").value.trim();
    if (!zip) return alert("Enter a ZIP code");
    try {
      const geoRes = await fetch(`https://api.zippopotam.us/us/${zip}`);
      if (!geoRes.ok) throw new Error("ZIP not found");
      const geoData = await geoRes.json();
      const lat = geoData.places[0].latitude;
      const lon = geoData.places[0].longitude;

      const pointRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
      const pointData = await pointRes.json();
      const forecastGridUrl = pointData.properties.forecastGridData;

      const gridRes = await fetch(forecastGridUrl);
      const gridData = await gridRes.json();
      const temp = gridData.properties.temperature.values[0].value;
      const dew = gridData.properties.dewpoint.values[0].value;
      const heatIndex = Math.round(temp + 0.5555 * (6.11 * Math.exp(5417.7530 * ((1/273.16) - (1/(dew+273.16)))) - 10));

      weatherData = { temp: temp.toFixed(1), dew: dew.toFixed(1), heatIndex };
      document.getElementById("weatherInfo").innerHTML = 
        `<p>Temp: ${weatherData.temp}°F<br>Dew Point: ${weatherData.dew}°F<br>Heat Index: ${weatherData.heatIndex}°F</p>`;
    } catch (err) {
      alert("Could not fetch weather: " + err.message);
    }
  }

  function toggleSidebar() {
    const sb = document.getElementById("sidebar");
    sb.style.display = sb.style.display === "block" ? "none" : "block";
  }

  document.getElementById("generateBtn").addEventListener("click", generateWorkout);
  document.getElementById("weatherBtn").addEventListener("click", fetchWeather);
</script>
</body>
</html>
