<script>
const distances = ["100", "200", "400", "600", "800", "1000", "1200", "mile"];
const metersLookup = { "100":100, "200":200, "400":400, "600":600, "800":800, "1000":1000, "1200":1200, "mile":1609 };

const minPaceForDistance = {
  "100": null,
  "200": "800m pace",
  "400": "mile pace",
  "600": "mile pace",
  "800": "3k pace",
  "1000": "5k Punch Pace",
  "1200": "HMP",
  "mile": "MP"
};

// ... paceChart & vdotTable same as before ...

function pickDistance(){ return distances[Math.floor(Math.random()*distances.length)]; }
function chooseReps(meters){ const maxReps=Math.max(1,Math.floor(1609/meters)); return Math.floor(Math.random()*maxReps)+1; }

function randomPaceFor(distance, vdot){
  if (distance === "100") return null;
  let startCat = minPaceForDistance[distance];

  // Apply restrictions based on reps
  if (distance === "400" && currentReps >= 3 && currentReps <= 4) startCat = "5k Punch Pace";
  if (distance === "200" && currentReps >= 5 && currentReps <= 8) startCat = "MP";

  const fast = paceChart[startCat]?.[vdot];
  const slow = paceChart["MP"]?.[vdot];
  if (!fast || !slow) return null;
  const lo = Math.min(toSec(fast), toSec(slow));
  const hi = Math.max(toSec(fast), toSec(slow));
  const r = Math.floor(lo + Math.random()*(hi - lo + 1));
  return toMMSS(r);
}

const input = document.getElementById("timeInput");
const resultBox = document.getElementById("result");
const outDist = document.getElementById("outDist");
const outPace = document.getElementById("outPace");
const outSplit = document.getElementById("outSplit");
const vdotNote = document.getElementById("vdotNote");
const paceNote = document.getElementById("paceNote");

(function init(){
  const saved = localStorage.getItem("coxpunch_5k");
  if (saved) input.value = saved;
})();

let currentReps = 0;

document.getElementById("generateBtn").addEventListener("click", () => {
  const v = (input.value||"").trim();
  const m = v.match(/^(\d{1,2}):([0-5]\d)$/);
  if(!m){ alert("Enter 5K time as mm:ss (e.g., 17:30)"); input.focus(); return; }

  localStorage.setItem("coxpunch_5k", v);

  const minutes = parseInt(m[1],10);
  const seconds = parseInt(m[2],10);
  const vdot = estimateVDOT(minutes, seconds);

  let distance = pickDistance();
  const meters = metersLookup[distance];
  currentReps = chooseReps(meters);

  let targetPaceText = "—";
  let splitText = "—";

  if (distance === "100"){
    currentReps = 4;
    targetPaceText = "All out";
    splitText = "All out";
    paceNote.textContent = "";
  } else {
    const rp = randomPaceFor(distance, vdot);
    targetPaceText = rp ? (rp + " /mi") : "—";
    if (rp){
      const paceSec = toSec(rp);
      const repTimeSec = (meters / 1609) * paceSec;
      splitText = toMMSS(repTimeSec);
    }
    paceNote.textContent = "";
  }

  // Add 6 strides at the end
  const finalDistText = (distance === "mile" ? "mile" : distance + "m") + " × " + currentReps + " + 6 strides";

  outDist.textContent = finalDistText;
  outPace.textContent = targetPaceText;
  outSplit.textContent = splitText;
  vdotNote.textContent = "VDOT ≈ " + vdot + " based on 5K " + minutes + ":" + seconds.toString().padStart(2,"0");

  resultBox.style.display = "block";
});
</script>
